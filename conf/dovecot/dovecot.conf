## Dovecot configuration file generated by YunoHost

dovecot_config_version = 2.4.0
dovecot_storage_version = 2.4.0

!include yunohost.d/pre-ext.conf

!include_try /usr/share/dovecot/protocols.d/*.protocol

listen = *, ::
auth_mechanisms = plain login

mail_driver = maildir
mail_home = /var/mail/%{user | username }
mail_path = /var/mail/%{user | username }
mail_uid = 500
mail_gid = 8

protocols = imap sieve

mail_plugins = $mail_plugins quota notify push_notification

###############################################################################
# generated 2023-06-13, Mozilla Guideline v5.7, Dovecot 2.3.19, OpenSSL 3.0.9, intermediate configuration
# https://ssl-config.mozilla.org/#server=dovecot&version=2.3.19&config=intermediate&openssl=3.0.9&guideline=5.7

ssl = required

ssl_server_cert_file = /etc/yunohost/certs/{{ main_domain }}/crt.pem
ssl_server_key_file = /etc/yunohost/certs/{{ main_domain }}/key.pem
{% for domain in domain_list.split() %}{% if domain != main_domain %}
local_name {{ domain }} {
  ssl_server_cert_file = /etc/yunohost/certs/{{ domain }}/crt.pem
  ssl_server_key_file = /etc/yunohost/certs/{{ domain }}/key.pem
}{% endif %}{% endfor %}

# curl https://ssl-config.mozilla.org/ffdhe2048.txt > /path/to/dhparam
ssl_server_dh_file = /usr/share/yunohost/ffdhe2048.pem

# intermediate configuration
ssl_min_protocol = TLSv1.2
ssl_cipher_list = ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305
ssl_server_prefer_ciphers = client

###############################################################################

ldap_uris = ldap://127.0.0.1
ldap_version = 3
# ldap_auth_dn =
ldap_base = ou=users,dc=yunohost,dc=org

passdb_ldap_bind = yes
passdb_default_password_scheme = SSHA

# Regular Yunohost accounts
passdb ldap {
  # bind = yes
  filter = (&(objectClass=inetOrgPerson)(uid=%n)(permission=cn=mail.main,ou=permission,dc=yunohost,dc=org))
  #fields {
  #  user = %{ldap:uid}
  #  password = %{ldap:userPassword}
  #}
}

# Internally, allow authentication from apps system user who have "enable_email = true"
passdb passwd-file {
  passwd_file_path = /etc/dovecot/app-senders-passwd
}

userdb ldap {
  filter = (&(objectClass=inetOrgPerson)(uid=%n)(permission=cn=mail.main,ou=permission,dc=yunohost,dc=org))
}

userdb passwd-file {
  passwd_file_path = /etc/dovecot/app-senders-passwd
}


protocol imap {
  imap_client_workarounds =
  mail_plugins {
    imap_quota = yes
    antispam = yes
  }
}

protocol lda {
  auth_socket_path = /var/run/dovecot/auth-master
  mail_plugins = quota sieve
  postmaster_address = postmaster@trixietests.yunohost.org
}

namespace inbox {
  inbox = yes

  mailbox Drafts {
    special_use = \Drafts
    auto = subscribe
  }
  mailbox Junk {
    special_use = \Junk
    auto = subscribe
  }
  mailbox Trash {
    special_use = \Trash
    auto = subscribe
  }
  mailbox Sent {
    special_use = \Sent
    auto = subscribe
  }
  mailbox "Sent Messages" {
    special_use = \Sent
  }
  mailbox "Archive" {
    special_use = \Archive
    auto = subscribe
  }
}

protocol sieve {
}

service auth {
  unix_listener /var/spool/postfix/private/auth {
    group = postfix
    mode = 0660
    user = postfix
  }
  unix_listener auth-master {
    group = mail
    mode = 0660
    user = vmail
  }
}

service quota-warning {
  executable = script /usr/bin/quota-warning.sh
  user = vmail
  unix_listener quota-warning {
  }
}

service stats {
    unix_listener stats-reader {
        user = vmail
        group = mail
        mode = 0660
    }

    unix_listener stats-writer {
        user = vmail
        group = mail
        mode = 0660
    }
}


sieve_script before {
  driver = file
  path = /var/mail/sievescript/%{user | username }/scripts/
  active_path = /var/mail/sievescript/%{user | username }/.dovecot.sieve
}


quota "User quota" {
  driver = maildir
  warning warn-95 {
    quota_storage_percentage = 95
    execute quota-warning {
      args = 95 %{user}
    }
  }
  warning warn-80 {
    quota_storage_percentage = 80
    execute quota-warning {
      args = 80 %{user}
    }
  }
  warning warn-under {
    quota_storage_percentage = 100
    # user is no longer over quota
    threshold = under
    execute quota-warning {
      args = below %{user}
    }
  }
}

namespace inbox {
  mailbox Trash {
    quota_ignore = yes
  }
  mailbox SPAM {
    quota_ignore = yes
  }
}

!include yunohost.d/post-ext.conf
